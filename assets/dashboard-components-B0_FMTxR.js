const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/analytics-components-33d9TC47.js","assets/react-vendor-Co8v5os9.js","assets/ui-components-BA32w1ww.js","assets/index-BRJKGoUE.js","assets/utils-BkWO3WEY.js","assets/charts-CWlq-tT4.js","assets/supabase-7VZN9XpM.js","assets/index-CGA1F0yl.css"])))=>i.map(i=>d[i]);
import{aq as B,ar as ke,as as Le,at as Re,au as Me,e as Oe,av as Ue,aw as oe,ax as Fe,s as H,u as qe,ay as ze,B as y,az as He,C as _,h as R,j as M,i as D,aA as $e,S as Be,a as Ke,b as We,c as Ye,d as T,aB as Ge,aC as Je,aD as Qe,aE as Xe,aF as Ze,aG as et,aH as tt,aI as st,aJ as at,aK as lt,aL as rt,aM as nt,aN as it}from"./index-BRJKGoUE.js";import{r as n,j as e,e as $,P as ce,E as ot,B as ct,c as dt,S as ut,L as mt}from"./react-vendor-Co8v5os9.js";const ht=n.lazy(()=>B(()=>import("./analytics-components-33d9TC47.js").then(g=>g.S),__vite__mapDeps([0,1,2,3,4,5,6,7]))),xt=n.lazy(()=>B(()=>import("./analytics-components-33d9TC47.js").then(g=>g.A),__vite__mapDeps([0,1,2,3,4,5,6,7]))),gt=n.lazy(()=>B(()=>import("./index-BRJKGoUE.js").then(g=>g.bk),__vite__mapDeps([3,1,2,4,5,6,7]))),pt=()=>{const{metrics:g,chartData:K,handleCSVUpload:N,hasData:O,csvData:v}=ke();return e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"flex justify-start items-center",children:e.jsx(Le,{onUpload:N,dataCount:v.length})}),e.jsx(Re,{}),e.jsx(n.Suspense,{fallback:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[1,2,3,4].map(u=>e.jsx("div",{className:"animate-pulse",children:e.jsx("div",{className:"h-32 bg-gray-200 rounded-lg"})},u))}),children:e.jsx(xt,{})}),e.jsx(n.Suspense,{fallback:e.jsx(Me,{}),children:e.jsx(ht,{data:O?K:void 0})}),e.jsx(n.Suspense,{fallback:e.jsx("div",{className:"animate-pulse",children:e.jsx("div",{className:"h-64 bg-gray-200 rounded-lg"})}),children:e.jsx(gt,{})})]})},vt=({onPageChange:g,onCreateRequest:K,onClientClick:N})=>{var se,ae;const[O,v]=n.useState(!1),[u,de]=n.useState(""),[b,ue]=n.useState("all"),[W,Y]=n.useState(null),[w,G]=n.useState(null),[me,J]=n.useState(!1),[he,Q]=n.useState(null),[d,U]=n.useState(null),[xe,V]=n.useState(!1),{user:i,loading:X}=Oe();console.log("🔍 [TourVirtuali] User from useAuth:",i),console.log("🔍 [TourVirtuali] User ID:",i==null?void 0:i.id);const{clients:c,projects:m,chatbots:A,analytics:E,isLoading:h,error:C,refreshData:S}=Ue((i==null?void 0:i.id)||"");console.log("🔍 [TourVirtuali] Dashboard data:",{hasUser:!!i,userId:i==null?void 0:i.id,authLoading:X,isLoading:h,error:C,clientsCount:(c==null?void 0:c.length)||0,projectsCount:(m==null?void 0:m.length)||0});const Z=()=>{console.log("[TourVirtuali] Manual refresh triggered"),S()},F=n.useRef(null),P=n.useRef(null),[o,I]=n.useState([]);n.useEffect(()=>{try{if(console.log("[TourVirtuali] Data transformation - isLoading:",h,"projects:",m==null?void 0:m.length,"clients:",c==null?void 0:c.length),console.log("[TourVirtuali] Projects data:",m),console.log("[TourVirtuali] Clients data:",c),!h){const t=m||[];if(console.log("[TourVirtuali] Projects from simple hook:",t),t&&t.length>0){const a=t.map(s=>{var ne,ie;const l=c==null?void 0:c.find(r=>r.id===s.end_client_id),L=(A==null?void 0:A.filter(r=>r.project_id===s.id))||[],j=(E==null?void 0:E.filter(r=>r.project_id===s.id))||[];if(!l||!l.id)return console.warn("Project has no valid client:",s.id,l),null;const f=j.filter(r=>r.metric_type==="view").reduce((r,p)=>r+(p.metric_value||0),0),Ee=j.filter(r=>r.metric_type==="unique_visitor").reduce((r,p)=>r+(p.metric_value||0),0),le=j.filter(r=>r.metric_type==="time_spent").reduce((r,p)=>r+(p.metric_value||0),0),z=le>0?le:0,Ie=j.filter(r=>r.metric_type==="lead_generated").reduce((r,p)=>r+(p.metric_value||0),0),re=f>0?Ie/f*100:0,x=L[0];return{id:s.id,client:{id:(l==null?void 0:l.id)||"",name:(l==null?void 0:l.name)||"Unknown Client",email:(l==null?void 0:l.email)||"",company:(l==null?void 0:l.company)||"Unknown Company",avatar:"",phone:(l==null?void 0:l.phone)||"",website:(l==null?void 0:l.website)||""},project:{title:s.title||"Untitled Project",description:s.description||`A ${oe(s.project_type)||"Virtual Tour"} project`,type:oe(s.project_type)||"Virtual Tour",category:s.category||"other",status:Fe(s.status)||"Setup",thumbnail_url:s.thumbnail_url||"https://images.unsplash.com/photo-1497366216548-37526070297c?w=400",created_at:s.created_at||new Date().toISOString(),updated_at:s.updated_at||new Date().toISOString()},chatbot:x?{name:x.name||"Assistant",isActive:x.is_active||!1,conversations:((ne=x.statistics)==null?void 0:ne.total_conversations)||0,satisfaction:((ie=x.statistics)==null?void 0:ie.satisfaction_rate)||0,language:x.language||"en",welcomeMessage:x.welcome_message||"Hello! How can I help you today?",fallbackMessage:x.fallback_message||"I apologize, but I need more information to help you."}:null,analytics:{totalViews:f||0,uniqueVisitors:Ee||0,avgSessionDuration:isNaN(z)?"0m 0s":`${Math.floor(z/60)}m ${Math.floor(z%60)}s`,conversionRate:isNaN(re)?0:Math.round(re*100)/100,lastActivity:s.updated_at||new Date().toISOString(),pageViews:f*1.8,bounceRate:0,avgPagesPerSession:0},createdAt:s.created_at||new Date().toISOString(),lastActivity:s.updated_at||new Date().toISOString()}}).filter(s=>s!==null);I(a)}else I([])}}catch(t){console.error("Error transforming project data:",t),I([])}},[h,c,m,A,E]),n.useEffect(()=>{if(!(i!=null&&i.id))return;console.log("[TourVirtuali] Setting up real-time subscriptions");const t=H.channel(`tour-virtuali-${i.id}`).on("postgres_changes",{event:"*",schema:"public",table:"projects"},a=>{console.log("[TourVirtuali] Project change detected:",a),k()}).on("postgres_changes",{event:"*",schema:"public",table:"end_clients"},a=>{console.log("[TourVirtuali] Client change detected:",a),k()}).on("postgres_changes",{event:"*",schema:"public",table:"chatbots"},a=>{console.log("[TourVirtuali] Chatbot change detected:",a),k()}).on("postgres_changes",{event:"*",schema:"public",table:"analytics"},a=>{console.log("[TourVirtuali] Analytics change detected:",a),k()}).subscribe(a=>{console.log("[TourVirtuali] Subscription status:",a)});return F.current=t,()=>{console.log("[TourVirtuali] Cleaning up real-time subscriptions"),F.current&&H.removeChannel(F.current),P.current&&clearTimeout(P.current)}},[i==null?void 0:i.id]);const k=()=>{P.current&&clearTimeout(P.current),P.current=setTimeout(()=>{console.log("[TourVirtuali] Triggering debounced refresh"),S()},1e3)},ge=async t=>{console.log("[TourVirtuali] New project created:",t),v(!1),console.log("[TourVirtuali] Refreshing data to show new project..."),S()},je=t=>{G(t)},fe=t=>{N==null||N(t.client)},pe=t=>{console.log("Manage project:",t)},ve=t=>{var a,s;if(console.log("Edit client for project:",t),console.log("Project client data:",t.client),console.log("Client ID:",(a=t.client)==null?void 0:a.id),console.log("Client name:",(s=t.client)==null?void 0:s.name),!t.client||!t.client.id){console.error("Invalid client data:",t.client),q({title:"Error",description:"Invalid client data. Cannot edit.",variant:"destructive"});return}Q(t.client),J(!0)},be=()=>{J(!1),Q(null)},ye=async()=>{await S()},{toast:q}=qe();if(X)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"})});if(C)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center max-w-md p-8",children:[e.jsx("div",{className:"text-red-600 mb-4",children:"⚠️ Error loading dashboard"}),e.jsx("p",{className:"text-gray-600 mb-4",children:C}),ze(),e.jsx(y,{onClick:Z,className:"mt-4",children:"Try Again"})]})});const Ne=t=>{U(t),V(!0)},we=async()=>{if(d)try{Y(d.id),console.log("🗑️ Deleting project:",d.id);const{error:t}=await H.from("projects").delete().eq("id",d.id);if(t)throw console.error("❌ Delete error:",t),t;console.log("✅ Project deleted successfully from database"),q({title:"Project deleted",description:"The project and its related data were removed successfully."}),U(null),V(!1),console.log("🔄 Refreshing data to update UI..."),S()}catch(t){console.error("❌ Error deleting project:",t),q({title:"Delete failed",description:"We could not delete this project. Please try again.",variant:"destructive"})}finally{Y(null)}},Ce=()=>{U(null),V(!1)},Se=(t,a)=>{I(s=>s.map(l=>l.id===t?{...l,project:{...l.project,status:a}}:l)),console.log(`Status changed to ${a} for project ${t}`)},ee=o.filter(t=>{var l,L,j,f;const a=(((l=t.client)==null?void 0:l.name)||"").toLowerCase().includes(u.toLowerCase())||(((L=t.client)==null?void 0:L.company)||"").toLowerCase().includes(u.toLowerCase())||(((j=t.project)==null?void 0:j.title)||"").toLowerCase().includes(u.toLowerCase()),s=b==="all"||((f=t.project)==null?void 0:f.status)===b;return a&&s}),te=o.reduce((t,a)=>{var s;return t+(((s=a.analytics)==null?void 0:s.totalViews)||0)},0),Pe=o.reduce((t,a)=>{var s;return t+(((s=a.analytics)==null?void 0:s.uniqueVisitors)||0)},0),_e=o.filter(t=>{var a;return((a=t.project)==null?void 0:a.status)==="active"}).length,De=o.filter(t=>t.chatbot).length,Te=o.reduce((t,a)=>{var s;return t+(((s=a.chatbot)==null?void 0:s.conversations)||0)},0),Ve=o.length>0?o.reduce((t,a)=>{var s;return t+(((s=a.chatbot)==null?void 0:s.satisfaction)||0)},0)/o.length:0,Ae=te>0?o.reduce((t,a)=>{var s;return t+(((s=a.analytics)==null?void 0:s.conversionRate)||0)},0)/o.length:0;return C?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-red-500 mb-4",children:"⚠️ Error loading data"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:C}),e.jsx(y,{onClick:()=>window.location.reload(),children:"Try Again"})]})}):h?e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-8 w-64 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-4 w-96 bg-gray-200 rounded animate-pulse"})]}),e.jsx("div",{className:"h-10 w-32 bg-gray-200 rounded animate-pulse"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[1,2,3,4].map(t=>e.jsx("div",{className:"h-24 bg-gray-200 rounded-lg animate-pulse"},t))}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx("div",{className:"h-10 flex-1 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-32 bg-gray-200 rounded animate-pulse"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[1,2,3,4,5,6].map(t=>e.jsx(He,{},t))})]}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-foreground mb-2",children:"Client Projects Hub"}),e.jsx("p",{className:"text-foreground-secondary text-sm sm:text-base",children:"Manage all your client projects and track their performance"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(y,{variant:"outline",onClick:Z,disabled:h,children:[e.jsx($,{className:"h-4 w-4 mr-2"}),h?"Refreshing...":"Refresh"]}),e.jsxs(y,{className:"bg-primary hover:bg-primary-hover",onClick:()=>v(!0),children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),"New Project"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs(_,{children:[e.jsxs(R,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(M,{className:"text-sm font-medium",children:"Total Projects"}),e.jsx($,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(D,{children:[e.jsx("div",{className:"text-2xl font-bold",children:o.length}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[_e," active"]})]})]}),e.jsxs(_,{children:[e.jsxs(R,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(M,{className:"text-sm font-medium",children:"Total Views"}),e.jsx(ot,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(D,{children:[e.jsx("div",{className:"text-2xl font-bold",children:te.toLocaleString()}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[Pe.toLocaleString()," unique visitors"]})]})]}),e.jsxs(_,{children:[e.jsxs(R,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(M,{className:"text-sm font-medium",children:"Active Chatbots"}),e.jsx(ct,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(D,{children:[e.jsx("div",{className:"text-2xl font-bold",children:De}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[Te.toLocaleString()," conversations"]})]})]}),e.jsxs(_,{children:[e.jsxs(R,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(M,{className:"text-sm font-medium",children:"Avg. Satisfaction"}),e.jsx(dt,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(D,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[Ve,"/5"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[Ae,"% conversion rate"]})]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ut,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx($e,{placeholder:"Search projects, clients, or companies...",value:u,onChange:t=>de(t.target.value),className:"pl-10"})]}),e.jsxs(Be,{value:b,onValueChange:ue,children:[e.jsx(Ke,{className:"w-full sm:w-48",children:e.jsx(We,{placeholder:"Filter by status"})}),e.jsxs(Ye,{children:[e.jsx(T,{value:"all",children:"All Projects"}),e.jsx(T,{value:"active",children:"Active"}),e.jsx(T,{value:"setup",children:"Setup"}),e.jsx(T,{value:"completed",children:"Completed"}),e.jsx(T,{value:"inactive",children:"Inactive"})]})]})]}),h?e.jsx(Ge,{type:"dashboard",message:"Loading your projects and clients..."}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:ee.map(t=>e.jsx(Je,{project:t,onViewDetails:fe,onManageProject:pe,onEditProject:ve,onDeleteProject:Ne,onStatusChange:Se,onSharePortal:je},t.id))}),!h&&ee.length===0&&e.jsx(_,{children:e.jsx(D,{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx($,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:u||b!=="all"?"No projects found":"Welcome to your Client Projects Hub"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:u||b!=="all"?"Try adjusting your search or filters to find projects":"Start building your virtual tour business by creating your first client project. You can manage projects, track analytics, and set up chatbots all from here."}),!u&&b==="all"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(y,{onClick:()=>v(!0),className:"mr-2",children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),"Create Your First Project"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Need help getting started? Check out our documentation or contact support."})]})]})})}),e.jsx(Qe,{isOpen:O,onClose:()=>v(!1),onProjectCreated:ge}),w&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50",children:e.jsx("div",{className:"bg-background rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Share Client Portal"}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>G(null),children:"×"})]}),e.jsx(Xe,{projectId:w.id,projectTitle:w.project.title,clientName:w.client.name,clientEmail:w.client.email})]})})}),e.jsx(Ze,{isOpen:me,onClose:be,client:he,onClientUpdated:ye}),e.jsx(et,{open:xe,onOpenChange:V,children:e.jsxs(tt,{children:[e.jsxs(st,{children:[e.jsx(at,{children:"Delete Project"}),e.jsxs(lt,{children:['Are you sure you want to delete "',((se=d==null?void 0:d.project)==null?void 0:se.title)||"Untitled",'" for ',((ae=d==null?void 0:d.client)==null?void 0:ae.name)||"this client","?",e.jsx("br",{}),e.jsx("br",{}),e.jsx("strong",{children:"This action cannot be undone."})," This will permanently remove:",e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"The project and all its data"}),e.jsx("li",{children:"Associated chatbots"}),e.jsx("li",{children:"Analytics and reports"}),e.jsx("li",{children:"Client requests"}),e.jsx("li",{children:"Uploaded assets"})]})]})]}),e.jsxs(rt,{children:[e.jsx(nt,{onClick:Ce,children:"Cancel"}),e.jsx(it,{onClick:we,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",disabled:W!==null,children:W?e.jsxs(e.Fragment,{children:[e.jsx(mt,{className:"h-4 w-4 mr-2 animate-spin"}),"Deleting..."]}):"Delete Project"})]})]})})]})};export{pt as D,vt as T};
